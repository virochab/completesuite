pipeline {
    agent any
    
    parameters {
        choice(
            name: 'TEST_TYPE',
            choices: [
                'all',
                'sanity',
                'bias',
                'aiquality',
                'rag',
                'security',
                'safety',
                'privacy',
                'agentic',
                'multiturn',
                'mcp',
                'ops',
                'unit',
                'performance'
            ],
            description: 'Select test type to run'
        )
        booleanParam(
            name: 'GENERATE_REPORTS',
            defaultValue: true,
            description: 'Generate metrics summary and evidence bundle'
        )
        booleanParam(
            name: 'ARCHIVE_ARTIFACTS',
            defaultValue: true,
            description: 'Archive test reports and evidence'
        )
    }
    
    options {
        buildDiscarder(logRotator(numToKeepStr: '30'))
        timeout(time: 4, unit: 'HOURS')
        timestamps()
        // Scheduled triggers - uncomment to enable automatic runs
        // Daily sanity: H 2 * * * (runs daily at 2 AM)
        // Weekly comprehensive: H 3 * * 0 (runs Sunday at 3 AM)
        // 
        // Note: You can also configure these in Jenkins UI:
        // Job Configuration → Build Triggers → Build periodically
        // pipelineTriggers([
        //     cron('H 2 * * *'),  // Daily sanity at 2 AM
        //     cron('H 3 * * 0')   // Weekly comprehensive on Sunday at 3 AM
        // ])
    }
    
    environment {
        PYTHON_VERSION = '3.11'
        VENV_PATH = "${WORKSPACE}/.venv"
        VENV_GARAK_PATH = "${WORKSPACE}/.venv-garak"
        VENV_GISKARD_PATH = "${WORKSPACE}/.venv-giskard"
        REPORTS_DIR = "${WORKSPACE}/reports"
        EVIDENCE_DIR = "${WORKSPACE}/evidence"
    }
    
    stages {
        stage('Checkout') {
            steps {
                checkout scm
            }
        }
        
        stage('Setup Environment') {
            steps {
                script {
                    def testType = params.TEST_TYPE ?: 'sanity'
                    def venvPath = getVenvPath(testType)
                    
                    echo "Setting up virtual environment for test type: ${testType}"
                    echo "Using virtual environment: ${venvPath}"
                    
                    bat """
                        @echo off
                        if not exist "${VENV_PATH}" (
                            echo Creating main virtual environment...
                            python -m venv "${VENV_PATH}"
                        )
                        call "${VENV_PATH}\\Scripts\\activate.bat"
                        pip install --upgrade pip setuptools wheel
                        pip install -r mainsuiterequirements.txt
                        echo Main environment setup complete
                    """
                    
                    // Setup Garak environment if needed
                    if (testType == 'security' || testType == 'all') {
                        bat """
                            @echo off
                            if not exist "${VENV_GARAK_PATH}" (
                                echo Creating Garak virtual environment...
                                python -m venv "${VENV_GARAK_PATH}"
                            )
                            call "${VENV_GARAK_PATH}\\Scripts\\activate.bat"
                            pip install --upgrade pip setuptools wheel
                            pip install garak || echo Warning: Could not install garak
                            echo Garak environment setup complete
                        """
                    }
                    
                    // Setup Giskard environment if needed
                    if (testType == 'safety' || testType == 'all') {
                        bat """
                            @echo off
                            if not exist "${VENV_GISKARD_PATH}" (
                                echo Creating Giskard virtual environment...
                                python -m venv "${VENV_GISKARD_PATH}"
                            )
                            call "${VENV_GISKARD_PATH}\\Scripts\\activate.bat"
                            pip install --upgrade pip setuptools wheel
                            pip install giskard || echo Warning: Could not install giskard
                            echo Giskard environment setup complete
                        """
                    }
                }
            }
        }
        
        stage('Run Tests') {
            steps {
                script {
                    // Determine test type based on parameter or default to sanity
                    def testType = params.TEST_TYPE
                    if (!testType || testType == 'null' || testType == '') {
                        // Check if this is a scheduled build
                        def causes = currentBuild.getBuildCauses('hudson.triggers.TimerTrigger$TimerTriggerCause')
                        if (causes && !causes.isEmpty()) {
                            // Scheduled build - determine type based on day
                            def currentDay = new Date().format('EEEE', TimeZone.getTimeZone('UTC'))
                            if (currentDay == 'Sunday') {
                                testType = 'all'  // Weekly comprehensive run
                                echo "Scheduled weekly comprehensive run detected"
                            } else {
                                testType = 'sanity'  // Daily sanity run
                                echo "Scheduled daily sanity run detected"
                            }
                        } else {
                            testType = 'sanity'  // Default for manual builds
                            echo "Manual build - using default sanity tests"
                        }
                    }
                    
                    def testCommand = getTestCommand(testType)
                    def venvPath = getVenvPath(testType)
                    
                    echo "Test Type: ${testType}"
                    echo "Using virtual environment: ${venvPath}"
                    
                    // Determine the working directory for tests
                    // Check if tests directory exists in current directory, otherwise look in llm-compliance
                    def testDir = fileExists("tests/conftest.py") ? "" : "llm-compliance"
                    
                    if (testDir) {
                        dir(testDir) {
                            bat """
                                @echo off
                                call "${venvPath}\\Scripts\\activate.bat"
                                echo Running test type: ${testType}
                                echo Test command: ${testCommand}
                                ${testCommand}
                            """
                        }
                    } else {
                        bat """
                            @echo off
                            call "${venvPath}\\Scripts\\activate.bat"
                            echo Running test type: ${testType}
                            echo Test command: ${testCommand}
                            ${testCommand}
                        """
                    }
                }
            }
            post {
                always {
                    junit allowEmptyResults: true, testResults: 'test-reports/junit-*.xml'
                }
            }
        }
        
        stage('Publish Test Results') {
            steps {
                script {
                    def testType = params.TEST_TYPE ?: 'sanity'
                    def testDir = fileExists("tests/conftest.py") ? "" : "llm-compliance"
                    
                    // Determine the JUnit XML file pattern based on test type
                    def junitPattern = "test-reports/junit-*.xml"
                    
                    if (testDir) {
                        dir(testDir) {
                            // Publish all JUnit XML files
                            junit testResults: junitPattern, allowEmptyResults: false
                            
                            // Archive the JUnit XML files
                            archiveArtifacts artifacts: junitPattern, allowEmptyArchive: true
                        }
                    } else {
                        // Publish all JUnit XML files
                        junit testResults: junitPattern, allowEmptyResults: false
                        
                        // Archive the JUnit XML files
                        archiveArtifacts artifacts: junitPattern, allowEmptyArchive: true
                    }
                }
            }
        }
        
        stage('Generate Reports') {
            when {
                expression { params.GENERATE_REPORTS == true }
            }
            steps {
                script {
                    bat """
                        @echo off
                        call "${VENV_PATH}\\Scripts\\activate.bat"
                        echo Generating metrics summary...
                        python -c "from utils.metricsHistoryTracker import MetricsHistoryTracker; tracker = MetricsHistoryTracker(); tracker.generate_summary_report()" || echo Warning: Could not generate metrics summary
                        
                        echo Building evidence bundle...
                        python scripts/build_evidence_bundle.py || echo Warning: Could not build evidence bundle
                    """
                }
            }
        }
        
        stage('Generate Plots') {
            when {
                expression { params.GENERATE_REPORTS == true }
            }
            steps {
                script {
                    // Determine the working directory for finding the plot CSV file
                    def testDir = fileExists("tests/conftest.py") ? "" : "llm-compliance"
                    
                    if (testDir) {
                        dir(testDir) {
                            // Find the most recent plot CSV file using Python (cross-platform)
                            def plotFile = bat(
                                script: """
                                    @echo off
                                    python -c "import glob, os; files = sorted(glob.glob('reports/multiple_agentic_metrics_summary_plot_*.csv'), key=os.path.getmtime, reverse=True); print(files[0] if files else '')"
                                """,
                                returnStdout: true
                            ).trim()
                            
                            if (plotFile) {
                                echo "Found plot CSV file: ${plotFile}"
                                def relativePlotFile = plotFile.replace('\\\\', '/')
                                // Use relative path from current directory context
                                if (relativePlotFile.contains('reports/')) {
                                    relativePlotFile = relativePlotFile.substring(relativePlotFile.indexOf('reports/'))
                                }
                                echo "Using plot file: ${relativePlotFile}"
                                
                                // Plot 1: Mean Scores Over Time
                                plot csvFileName: 'agentic_metrics_plot.csv',
                                     csvSeries: [[
                                         file: relativePlotFile,
                                         label: 'Task_Completion_mean',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Step_Efficiency_mean',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Plan_Adherence_mean',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Plan_Quality_mean',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ]],
                                     group: 'Agentic Metrics',
                                     numBuilds: '30',
                                     style: 'line',
                                     title: 'Agentic Metrics: Mean Scores Over Time',
                                     useDescr: true,
                                     yaxis: 'Score',
                                     excludeZero: false,
                                     keepRecords: true
                                
                                // Plot 2: Mean Scores vs Thresholds
                                plot csvFileName: 'agentic_thresholds_plot.csv',
                                     csvSeries: [[
                                         file: relativePlotFile,
                                         label: 'Task_Completion_mean',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Task_Completion_threshold',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Step_Efficiency_mean',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Step_Efficiency_threshold',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Plan_Adherence_mean',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Plan_Adherence_threshold',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Plan_Quality_mean',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Plan_Quality_threshold',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ]],
                                     group: 'Agentic Metrics',
                                     numBuilds: '30',
                                     style: 'line',
                                     title: 'Agentic Metrics: Mean Scores vs Thresholds',
                                     useDescr: true,
                                     yaxis: 'Score',
                                     excludeZero: false,
                                     keepRecords: true
                                
                                // Plot 3: Number of Tests Over Time
                                plot csvFileName: 'agentic_tests_count_plot.csv',
                                     csvSeries: [[
                                         file: relativePlotFile,
                                         label: 'Task_Completion_tests',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Step_Efficiency_tests',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Plan_Adherence_tests',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Plan_Quality_tests',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ]],
                                     group: 'Agentic Metrics',
                                     numBuilds: '30',
                                     style: 'line',
                                     title: 'Agentic Metrics: Number of Tests Over Time',
                                     useDescr: true,
                                     yaxis: 'Number of Tests',
                                     excludeZero: false,
                                     keepRecords: true
                                
                                // Plot 4: Pass Rate Over Time
                                plot csvFileName: 'agentic_pass_rate_plot.csv',
                                     csvSeries: [[
                                         file: relativePlotFile,
                                         label: 'Task_Completion_pass_rate',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Step_Efficiency_pass_rate',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Plan_Adherence_pass_rate',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ], [
                                         file: relativePlotFile,
                                         label: 'Plan_Quality_pass_rate',
                                         inclusionFlag: 'INCLUDE_BY_STRING',
                                         exclusionValues: '',
                                         url: relativePlotFile,
                                         displayTableFlag: true
                                     ]],
                                     group: 'Agentic Metrics',
                                     numBuilds: '30',
                                     style: 'line',
                                     title: 'Agentic Metrics: Pass Rate Over Time',
                                     useDescr: true,
                                     yaxis: 'Pass Rate (%)',
                                     excludeZero: false,
                                     keepRecords: true
                            } else {
                                echo "No plot CSV file found (multiple_agentic_metrics_summary_plot_*.csv) to generate plots from"
                            }
                        }
                    } else {
                        // Find the most recent plot CSV file using Python (cross-platform)
                        def plotFile = bat(
                            script: """
                                @echo off
                                python -c "import glob, os; files = sorted(glob.glob('reports/multiple_agentic_metrics_summary_plot_*.csv'), key=os.path.getmtime, reverse=True); print(files[0] if files else '')"
                            """,
                            returnStdout: true
                        ).trim()
                        
                        if (plotFile) {
                            echo "Found plot CSV file: ${plotFile}"
                            def relativePlotFile = plotFile.replace('\\\\', '/')
                            if (relativePlotFile.contains('reports/')) {
                                relativePlotFile = relativePlotFile.substring(relativePlotFile.indexOf('reports/'))
                            }
                            echo "Using plot file: ${relativePlotFile}"
                            
                            // Plot 1: Mean Scores Over Time
                            plot csvFileName: 'agentic_metrics_plot.csv',
                                 csvSeries: [[
                                     file: relativePlotFile,
                                     label: 'Task_Completion_mean',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Step_Efficiency_mean',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Plan_Adherence_mean',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Plan_Quality_mean',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ]],
                                 group: 'Agentic Metrics',
                                 numBuilds: '30',
                                 style: 'line',
                                 title: 'Agentic Metrics: Mean Scores Over Time',
                                 useDescr: true,
                                 yaxis: 'Score',
                                 excludeZero: false,
                                 keepRecords: true
                            
                            // Plot 2: Mean Scores vs Thresholds
                            plot csvFileName: 'agentic_thresholds_plot.csv',
                                 csvSeries: [[
                                     file: relativePlotFile,
                                     label: 'Task_Completion_mean',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Task_Completion_threshold',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Step_Efficiency_mean',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Step_Efficiency_threshold',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Plan_Adherence_mean',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Plan_Adherence_threshold',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Plan_Quality_mean',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Plan_Quality_threshold',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ]],
                                 group: 'Agentic Metrics',
                                 numBuilds: '30',
                                 style: 'line',
                                 title: 'Agentic Metrics: Mean Scores vs Thresholds',
                                 useDescr: true,
                                 yaxis: 'Score',
                                 excludeZero: false,
                                 keepRecords: true
                            
                            // Plot 3: Number of Tests Over Time
                            plot csvFileName: 'agentic_tests_count_plot.csv',
                                 csvSeries: [[
                                     file: relativePlotFile,
                                     label: 'Task_Completion_tests',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Step_Efficiency_tests',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Plan_Adherence_tests',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Plan_Quality_tests',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ]],
                                 group: 'Agentic Metrics',
                                 numBuilds: '30',
                                 style: 'line',
                                 title: 'Agentic Metrics: Number of Tests Over Time',
                                 useDescr: true,
                                 yaxis: 'Number of Tests',
                                 excludeZero: false,
                                 keepRecords: true
                            
                            // Plot 4: Pass Rate Over Time
                            plot csvFileName: 'agentic_pass_rate_plot.csv',
                                 csvSeries: [[
                                     file: relativePlotFile,
                                     label: 'Task_Completion_pass_rate',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Step_Efficiency_pass_rate',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Plan_Adherence_pass_rate',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ], [
                                     file: relativePlotFile,
                                     label: 'Plan_Quality_pass_rate',
                                     inclusionFlag: 'INCLUDE_BY_STRING',
                                     exclusionValues: '',
                                     url: relativePlotFile,
                                     displayTableFlag: true
                                 ]],
                                 group: 'Agentic Metrics',
                                 numBuilds: '30',
                                 style: 'line',
                                 title: 'Agentic Metrics: Pass Rate Over Time',
                                 useDescr: true,
                                 yaxis: 'Pass Rate (%)',
                                 excludeZero: false,
                                 keepRecords: true
                        } else {
                            echo "No plot CSV file found (multiple_agentic_metrics_summary_plot_*.csv) to generate plots from"
                        }
                    }
                }
            }
        }
        
        stage('Archive Artifacts') {
            when {
                expression { params.ARCHIVE_ARTIFACTS == true }
            }
            steps {
                script {
                    archiveArtifacts artifacts: 'test-reports/**', fingerprint: true, allowEmptyArchive: true
                    archiveArtifacts artifacts: 'evidence/**', fingerprint: true, allowEmptyArchive: true
                    archiveArtifacts artifacts: 'reports/**/*.csv', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'reports/**/*.json', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'reports/**/*.html', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'reports/**/*.jsonl', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'reports/**/*.png', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'reports/metrics_history.csv', allowEmptyArchive: true
                    archiveArtifacts artifacts: 'reports/metrics_summary.json', allowEmptyArchive: true
                }
            }
        }
    }
    
    post {
        always {
            script {
                // Cleanup
                bat """
                    @echo off
                    echo Cleaning up temporary files...
                    for /r . %%d in (__pycache__) do @if exist "%%d" rd /s /q "%%d"
                    for /r . %%f in (*.pyc) do @if exist "%%f" del /q "%%f"
                """
            }
        }
        success {
            echo "✅ All tests passed successfully!"
        }
        failure {
            echo "❌ Some tests failed. Check the test results above."
        }
        unstable {
            echo "⚠️ Some tests were unstable or had warnings."
        }
    }
}

// Helper function to get test command based on test type
def getTestCommand(testType) {
    def commands = [:]
    
    // Sanity run - quick tests for daily validation
    commands['sanity'] = '''
        echo "Running sanity tests..."
        if not exist "test-reports" mkdir test-reports
        pytest -v -x --tb=short \
            tests/unit/ \
            tests/security/test_rate_limit.py \
            tests/security/test_authz.py \
            tests/privacy/test_pii_output.py \
            tests/safety/test_deepeval_safety_compliance.py \
            --junitxml=test-reports/junit-sanity.xml \
            -m "not slow" || true
    '''
    
    // All tests - comprehensive run (handles multiple venvs)
    commands['all'] = '''
        echo "Running all tests (comprehensive run)..."
        if not exist "test-reports" mkdir test-reports
        
        # Run tests that use main venv
        echo "Running tests with main virtual environment..."
        pytest -v --tb=short \
            tests/eval/ \
            tests/rag/ \
            tests/privacy/ \
            tests/multiturn/ \
            tests/agentic/ \
            tests/mcp/ \
            tests/ops/ \
            tests/unit/ \
            tests/safety/test_deepeval_safety_compliance.py \
            tests/safety/test_misuse_toxicity.py \
            tests/safety/test_non_advice_toxicity.py \
            tests/safety/test_role_violation_toxicity.py \
            tests/safety/test_pii_output.py \
            tests/security/test_authz.py \
            tests/security/test_rate_limit.py \
            tests/security/test_tool_allowlist.py \
            --junitxml=test-reports/junit-all-main.xml || true
        
        # Run Garak tests with .venv-garak
        echo "Running Garak tests with .venv-garak..."
        source ${VENV_GARAK_PATH}/bin/activate || . ${VENV_GARAK_PATH}/Scripts/activate
        pytest -v --tb=short \
            tests/security/test_garak.py \
            tests/security/test_garak_tiers.py \
            --junitxml=test-reports/junit-all-garak.xml || true
        
        # Run Giskard tests with .venv-giskard
        echo "Running Giskard tests with .venv-giskard..."
        source ${VENV_GISKARD_PATH}/bin/activate || . ${VENV_GISKARD_PATH}/Scripts/activate
        pytest -v --tb=short \
            tests/safety/test_giskard_safety.py \
            tests/safety/test_rag_giskard_safety.py \
            --junitxml=test-reports/junit-all-giskard.xml || true
    '''
    
    // Bias tests
    commands['bias'] = '''
        echo "Running bias tests..."
        if not exist "test-reports" mkdir test-reports
        pytest -v --tb=short \
            tests/eval/test_deepeval_counterfactual_bias.py \
            --junitxml=test-reports/junit-bias.xml || true
    '''
    
    // AI Quality / Behaviour tests
    commands['aiquality'] = '''
        echo "Running AI quality/behaviour tests..."
        if not exist "test-reports" mkdir test-reports
        pytest -v --tb=short \
            tests/eval/test_deepeval_behaviour.py \
            --junitxml=test-reports/junit-aiquality.xml || true
    '''
    
    // RAG tests
    commands['rag'] = '''
        echo "Running RAG tests..."
        if not exist "test-reports" mkdir test-reports
        pytest -v --tb=short \
            tests/rag/test_ragas_rag.py \
            --junitxml=test-reports/junit-rag.xml || true
    '''
    
    // Security tests (uses .venv-garak for Garak tests)
    commands['security'] = '''
        echo "Running security tests..."
        if not exist "test-reports" mkdir test-reports
        # Run non-Garak tests with main venv
        pytest -v --tb=short \
            tests/security/test_authz.py \
            tests/security/test_rate_limit.py \
            tests/security/test_tool_allowlist.py \
            --junitxml=test-reports/junit-security-nongarak.xml || true
        
        # Run Garak tests with .venv-garak
        echo "Running Garak tests with .venv-garak..."
        source ${VENV_GARAK_PATH}/bin/activate || . ${VENV_GARAK_PATH}/Scripts/activate
        pytest -v --tb=short \
            tests/security/test_garak.py \
            tests/security/test_garak_tiers.py \
            --junitxml=test-reports/junit-security-garak.xml || true
    '''
    
    // Safety tests (uses .venv-giskard for Giskard tests)
    commands['safety'] = '''
        echo "Running safety tests..."
        if not exist "test-reports" mkdir test-reports
        # Run non-Giskard tests with main venv
        pytest -v --tb=short \
            tests/safety/test_deepeval_safety_compliance.py \
            tests/safety/test_misuse_toxicity.py \
            tests/safety/test_non_advice_toxicity.py \
            tests/safety/test_role_violation_toxicity.py \
            tests/safety/test_pii_output.py \
            --junitxml=test-reports/junit-safety-nongiskard.xml || true
        
        # Run Giskard tests with .venv-giskard
        echo "Running Giskard tests with .venv-giskard..."
        source ${VENV_GISKARD_PATH}/bin/activate || . ${VENV_GISKARD_PATH}/Scripts/activate
        pytest -v --tb=short \
            tests/safety/test_giskard_safety.py \
            tests/safety/test_rag_giskard_safety.py \
            --junitxml=test-reports/junit-safety-giskard.xml || true
    '''
    
    // Privacy tests
    commands['privacy'] = '''
        echo "Running privacy tests..."
        if not exist "test-reports" mkdir test-reports
        pytest -v --tb=short \
            tests/privacy/test_pii_output.py \
            tests/privacy/test_right_to_erasure.py \
            tests/privacy/test_pii_logs_traces.py \
            tests/privacy/testPiiprompts.py \
            --junitxml=test-reports/junit-privacy.xml || true
    '''
    
    // Agentic tests - run only test_multiple_agentic_metrics.py
    commands['agentic'] = '''
        echo Running agentic tests...
        if not exist "test-reports" mkdir test-reports
        pytest -v --tb=short tests/agentic/component/test_multiple_agentic_metrics.py --junitxml=test-reports/junit-agentic.xml || echo Tests completed
    '''
    
    // Multiturn tests
    commands['multiturn'] = '''
        echo "Running multiturn tests..."
        if not exist "test-reports" mkdir test-reports
        pytest -v --tb=short \
            tests/multiturn/ \
            --junitxml=test-reports/junit-multiturn.xml || true
    '''
    
    // MCP tests
    commands['mcp'] = '''
        echo "Running MCP tests..."
        if not exist "test-reports" mkdir test-reports
        pytest -v --tb=short \
            tests/mcp/test_deepeval_mcp.py \
            --junitxml=test-reports/junit-mcp.xml || true
    '''
    
    // Operations tests
    commands['ops'] = '''
        echo "Running operations tests..."
        if not exist "test-reports" mkdir test-reports
        pytest -v --tb=short \
            tests/ops/test_fallbacks.py \
            tests/ops/test_latency_budget.py \
            --junitxml=test-reports/junit-ops.xml || true
    '''
    
    // Unit tests
    commands['unit'] = '''
        echo "Running unit tests..."
        if not exist "test-reports" mkdir test-reports
        pytest -v --tb=short \
            tests/unit/ \
            --junitxml=test-reports/junit-unit.xml || true
    '''
    
    // Performance tests (Locust load testing)
    commands['performance'] = '''
        echo "Running performance/load tests..."
        echo "Note: This requires the FastAPI server to be running"
        echo "Starting FastAPI server in background..."
        # Start server in background (adjust as needed)
        # python -m uvicorn app.fastapiragpdfagent:app --host 0.0.0.0 --port 8000 &
        # sleep 10
        # Run Locust tests
        # locust -f tests/performance/locustLoad.py --host=http://localhost:8000 -u 10 -r 2 --run-time 2m --headless --csv=reports/performance/locust_results --html=reports/performance/locust_report.html || true
        echo "Performance tests require manual server setup"
    '''
    
    return commands[testType] ?: commands['sanity']
}

// Helper function to get virtual environment path based on test type
def getVenvPath(testType) {
    // Security tests use Garak venv
    if (testType == 'security') {
        return env.VENV_GARAK_PATH
    }
    // Safety tests use Giskard venv
    else if (testType == 'safety') {
        return env.VENV_GISKARD_PATH
    }
    // For 'all' tests, default to main venv (individual test commands handle their own venvs)
    // All other test types (agentic, bias, rag, etc.) use main venv
    else {
        return env.VENV_PATH
    }
}
